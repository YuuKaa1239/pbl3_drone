<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <title>Drone Control Interface</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #220000;
            color: #ffffff;
        }
        .control-panel {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            background-color: #440000;
        }
        #battery_status {
            font-size: 14px;
        }
        .controls-container {
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #throttle-slider {
            -webkit-appearance: slider-vertical;
            width: 20px;
            height: 200px;
        }
        #roll-slider {
            width: 200px;
            margin-top: 20px;
        }
        .joystick-container {
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #440000;
            border-radius: 50%;
        }
        #joystick {
            width: 50px;
            height: 50px;
            background-color: #ff0000;
            border-radius: 50%;
            position: absolute;
            top: 75px;
            left: 75px;
            cursor: grab;
        }
        #joystick:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div id="geometry">
            X: <span id="X_geo"></span>
            Y: <span id="Y_geo"></span>
            Z: <span id="Z_geo"></span>
        </div>
        <div id="status-display">
            Throttle: <span id="throttle-display">0</span>
            Roll: <span id="roll-display">1500</span> 
            Pitch: <span id="pitch-display">1500</span> 
            Yaw: <span id="yaw-display">1500</span>
        </div>
        <div id="battery_status">
            Battery: <span id="bat_status">%</span>
        </div>
        <div id="mqtt_status">MQTT Status: <span id="mqtt_status_display">Disconnected</span></div>
    </div>

    <div class="controls-container">
        <div class="slider-container">
            <input type="range" id="throttle-slider" min="1000" max="2000" value="1000" orient="vertical">
            <label for="throttle-slider">Throttle</label>
            <input type="range" id="roll-slider" min="1000" max="2000" value="1500">
            <label for="roll-slider">Roll</label>
        </div>

        <div class="joystick-container">
            <div id="joystick"></div>
        </div>
    </div>

    <script>
        const mqttStatusDisplay = document.getElementById('mqtt_status_display');
        const brokerUrl = "wss://8b28df54d30c4a2b8d0d33b102030c12.s1.eu.hivemq.cloud:8884/mqtt";
        const options = {
            clientId: 'ESPClient',
            username: 'peppa',
            password: 'Peppa_pig1'
        };

        // Initialize the MQTT client
        const client = mqtt.connect(brokerUrl, options);

        // Setup the callbacks
        client.on('connect', function () {
            mqttStatusDisplay.textContent = 'Connected';
            console.log("Connected to MQTT broker");
            client.subscribe('drone/transfer');
        });

        client.on('error', function (error) {
            mqttStatusDisplay.textContent = 'Connection error: ' + error.message;
        });

        client.on('message', function (topic, message) {
            const data = JSON.parse(message.toString());
            document.getElementById('X_geo').textContent = data.x || '0';
            document.getElementById('Y_geo').textContent = data.y || '0';
            document.getElementById('Z_geo').textContent = data.z || '0';
            document.getElementById('bat_status').textContent = data.battery_status || '0%';
        });

        const throttleSlider = document.getElementById('throttle-slider');
        const rollSlider = document.getElementById('roll-slider');
        const joystick = document.getElementById('joystick');
        const joystickContainer = document.querySelector('.joystick-container');

        const throttleDisplay = document.getElementById('throttle-display');
        const rollDisplay = document.getElementById('roll-display');
        const pitchDisplay = document.getElementById('pitch-display');
        const yawDisplay = document.getElementById('yaw-display');

        let isDragging = false;

        const initialJoystickPosition = {
            top: 75,
            left: 75
        };

        throttleSlider.addEventListener('input', updateThrottle);
        rollSlider.addEventListener('input', updateRoll);
        joystickContainer.addEventListener('mousedown', startDragging);
        joystickContainer.addEventListener('mouseup', stopDragging);
        joystickContainer.addEventListener('mouseleave', stopDragging);
        joystickContainer.addEventListener('mousemove', moveJoystick);

        function updateThrottle() {
            throttleDisplay.textContent = throttleSlider.value;
            publishDroneData();
        }

        function updateRoll() {
            rollDisplay.textContent = rollSlider.value;
            publishDroneData();
        }

        function startDragging(event) {
            isDragging = true;
            moveJoystick(event);
        }

        function stopDragging() {
            isDragging = false;
            resetJoystickPosition();
            publishDroneData();
        }

        function moveJoystick(event) {
            if (isDragging) {
                let rect = joystickContainer.getBoundingClientRect();
                let x = event.clientX - rect.left - joystick.offsetWidth / 2;
                let y = event.clientY - rect.top - joystick.offsetHeight / 2;

                x = Math.max(0, Math.min(x, joystickContainer.offsetWidth - joystick.offsetWidth));
                y = Math.max(0, Math.min(y, joystickContainer.offsetHeight - joystick.offsetHeight));

                joystick.style.left = `${x}px`;
                joystick.style.top = `${y}px`;

                let pitchValue = 1000 + ((y / (joystickContainer.offsetHeight - joystick.offsetHeight)) * 1000);
                let yawValue = 1000 + ((x / (joystickContainer.offsetWidth - joystick.offsetWidth)) * 1000);

                pitchDisplay.textContent = pitchValue.toFixed(0);
                yawDisplay.textContent = yawValue.toFixed(0);
            }
        }

        function resetJoystickPosition() {
            joystick.style.top = `${initialJoystickPosition.top}px`;
            joystick.style.left = `${initialJoystickPosition.left}px`;
            pitchDisplay.textContent = "1500";
            yawDisplay.textContent = "1500";
        }

        function publishDroneData() {
            const data = {
                throttle: parseInt(throttleSlider.value),
                roll: parseInt(rollSlider.value),
                pitch: parseInt(pitchDisplay.textContent),
                yaw: parseInt(yawDisplay.textContent)
            };
            client.publish('drone/transfer', JSON.stringify(data));
        }
    </script>
</body>
</html>
